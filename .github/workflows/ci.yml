name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

jobs:
  test:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    container:
      image: python:3.14-slim
    steps:
      - name: Install basic dependencies
        run: |
          apt-get update
          apt-get install -y git curl make
          curl -fsSL https://deb.nodesource.com/setup_18.x | bash -
          apt-get install -y nodejs

      - name: "Checkout the repository"
        uses: actions/checkout@v4

      - name: Mark Git directory as safe (needed when using Github runners)
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: "Install uv"
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install module and dependencies
        run: |
          make install-dev

      - name: Lint
        run: make lint

      - name: Unit tests with pytest
        run: |
          uv run pytest -svv ./tests/unit --doctest-modules --junitxml=./reports/junit-result.xml

      - name: Full tests with pytest and coverage
        run: make test-cov

      - name: Upload tests results to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          report_type: test_results
          files: ./reports/junit-result.xml

      - name: Upload coverage report to Codecov
        uses: codecov/codecov-action@v5
        with:
          token: ${{ secrets.CODECOV_TOKEN }}
          files: ./reports/coverage.xml

      - name: Upload coverage
        uses: actions/upload-artifact@v4
        with:
          name: cov-summary
          path: reports/coverage.xml
          if-no-files-found: error

  security:
    needs: test
    runs-on: ubuntu-latest
    container:
      image: python:3.14-slim
    permissions:
      security-events: write

      # Required to fetch internal or private CodeQL packs
      packages: read

      actions: read
      contents: read

    steps:
      - name: Install basic dependencies
        run: |
          apt-get update
          apt-get install -y git curl make
          curl -fsSL https://deb.nodesource.com/setup_20.x | bash -
          apt-get install -y nodejs

      - name: "Checkout the repository"
        uses: actions/checkout@v4

      - name: Mark Git directory as safe (needed when using Github runners)
        run: git config --global --add safe.directory "$GITHUB_WORKSPACE"

      - name: "Install uv"
        uses: astral-sh/setup-uv@v5
        with:
          enable-cache: true

      - name: Install module and dependencies
        run: |
          make install-dev

      - name: Run Bandit
        run: |
          uv run bandit -r ./python_template \
            -f sarif \
            -o bandit_report.sarif \
            || true

      - name: Create requirements.txt for next action
        run: |
          uv export --format requirements-txt > requirements.txt

      - name: Security vulnerabilities scan on dependencies
        run: |
          uv run pip-audit
        continue-on-error: true

      - uses: github/codeql-action/init@v4
        with:
          languages: python

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: "/language:python"

      - uses: github/codeql-action/upload-sarif@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          sarif_file: bandit_report.sarif

  coverage-to-pr:
      needs: test
      runs-on: ubuntu-latest
      timeout-minutes: 20
      permissions:
        actions: write
        contents: read
        packages: read
        pull-requests: write
        checks: write
        issues: write
      steps:
        - uses: actions/download-artifact@v4
          with:
            name: cov-summary

        - name: Code Coverage Summary
          uses: 5monkeys/cobertura-action@master
          with:
            path: coverage.xml
            fail_below_threshold: false
            show_line: true
            show_missing: true
            minimum_coverage: 80

        - name: Delete Artifact
          uses: geekyeggo/delete-artifact@v5
          with:
            name: cov-summary
